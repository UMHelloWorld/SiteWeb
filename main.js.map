{"version":3,"sources":["main.es6.js"],"names":[],"mappings":"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","file":"main.es6.js","sourcesContent":["/*\n\tPour tester, lancer la commande \"babel-node main.es6.js\"\n\n\tIl faut avoir installé : \n\t - nodejs ;\n\t - npm ;\n\t - les modules listés dans package.json ;\n\t - babel\n\t - stylus\n*/\nrequire(\"core-js\");\n\nlet express = require('express');\nlet bodyParser = require('body-parser');\nlet session = require('express-session');\n\nlet generateSecretSession = (old) => {\n\tlet r = (old||'') + parseInt(Math.random()*100000000).toString(36);\n\treturn (r.length<25) ? generateSecretSession(r) : r;\n};\n\nlet getSecretSession = () => {\n\tlet value = '';\n\ttry{\n\t\tvalue = require('fs').readFileSync('session-secret').toString();\n\t}catch(e){}\n\tif(value==''){\n\t\tvalue = generateSecretSession();\n\t\trequire('fs').writeFileSync('session-secret', value);\n\t}\n\treturn value;\n};\nlet sha1sum = (input) => require('crypto').createHash('sha1').update(input).digest('hex');\n\nlet mysql      = require('mysql');\nlet connection = mysql.createConnection(JSON.parse(require('fs').readFileSync('config-mysql.json').toString()));\nconnection.connect();\n\nlet app = express();\napp.set('trust proxy', 1);\napp.use(session({\n\tsecret: getSecretSession(),\n\tresave: false,\n\tsaveUninitialized: false\n}))\n\n//Pour les requêtes POST\napp.use(bodyParser.urlencoded({ extended: true }));\napp.use(bodyParser.json());\n\n//Le répertoire /static/ est considéré comme statique\napp.use(\"/static\", express.static(__dirname + \"/static\"));\n//Les vues sont stockées dans /views\napp.set('views', __dirname + '/views')\n//Les vues sont en jade, préprocesseur pour HTML\napp.set('view engine', 'jade');\n\nlet pages = [\n\t{\n\t\turl: 'index',\n\t\ticon: 'home',\n\t\ttitle: 'Accueil',\n\t\tneed: []\n\t},\n\t{\n\t\turl: 'calendar',\n\t\ticon: 'calendar',\n\t\ttitle: 'Planning',\n\t\tneed: []\n\t},\n\t{\n\t\turl: 'documents',\n\t\ticon: 'book',\n\t\ttitle: 'Cours',\n\t\tneed: []\n\t},\n\t{\n\t\turl: 'tutoring',\n\t\ticon: 'graduation-cap',\n\t\ttitle: 'Tutorat & entraide',\n\t\tneed: []\n\t},\n\t{\n\t\turl: 'sign-in',\n\t\ticon: 'sign-in',\n\t\ttitle: 'Connexion',\n\t\tneed: ['not-connected']\n\t},\n\t{\n\t\turl: 'sign-out',\n\t\ticon: 'sign-out',\n\t\ttitle: 'Déconnexion',\n\t\tneed: ['connected']\n\t},\n];\n\n\napp.get('/', (req, res) => {\n\tres.redirect(\"/index\");\n});\n\n\nlet queries = {};\n[\n\t'getTopics',\n\t'getDocumentsWithCourseInfo'\n].forEach((name) => {queries[name] = require('fs').readFileSync('./sql/'+name+'.sql').toString()});\n\napp.use('/api', require('./api/main.js')(express, {connection: connection, queries: queries}));\n\napp.get('/forum/', (req, res) => {\n\tconnection.query(queries.getTopics, function(err, results){\n\t\trender(req, res, 'tutoring', {\n\t\t\tshowForum: true,\n\t\t\tshowTopic: true,\n\t\t\ttopics: results.map(r => \n\t\t\t\t({\n\t\t\t\t\tid: +r.id,\n\t\t\t\t\tannotationId: +r.annotationId,\n\t\t\t\t\tuserId: +r.userId,\n\t\t\t\t\ttitle: r.title,\n\t\t\t\t\tsolved: Boolean(r.solved),\n\t\t\t\t\tvalidAnswer: Boolean(r.validAnswer)\n\t\t\t\t})\n\t\t\t)\n\t\t});\n\t});\n});\n\nfunction render(req, res, page, params){\n\tres.render(\"index.jade\", \n\t\t{\n\t\t\tpages: pages.filter((page) => page.need.filter((requirement) => {\n\t\t\t\tif(requirement=='connected' && req.session.connected)\n\t\t\t\t\treturn false;\n\t\t\t\tif(requirement=='not-connected' && !req.session.connected)\n\t\t\t\t\treturn false;\n\t\t\t\treturn true;\n\t\t\t}).length==0).map(\n\t\t\t\t(page) => ({\n\t\t\t\t\turl: page.url,\n\t\t\t\t\ttitle: page.title,\n\t\t\t\t\ticon: page.icon,\n\t\t\t\t\tisActive: (page.url==page)\n\t\t\t\t})\n\t\t\t),\n\t\t\tpage: page,\n\t\t\tparams: params || {},\n\t\t\turlParams: req.params,\n\t\t\tdbg: JSON.stringify(params)\n\t\t}\n\t);\n}\n\n\napp.get('/sign-out', (req, res) => {\n\treq.session.destroy();\n\tres.redirect('/');\n});\n\napp.post('/sign-in', (req, res) => {\n\tconsole.log(req.body);\n\tif(!req.body.mail || !req.body.password)\n\t\treturn res.redirect('/sign-in');\n\tconnection.query('SELECT * FROM User WHERE (email_perso = ? OR email_university = ?) AND password = UNHEX(?) LIMIT 1', [\n\t\t\treq.body.mail, req.body.mail, sha1sum(req.body.password)\n\t\t], function(err, result){\n\t\t\tif(result.length){\n\t\t\t\treq.session.connected = true;\n\t\t\t\tObject.assign(req.session, result.pop());\n\t\t\t}\n\t\t\tconsole.log(req.session);\n\t\t\tres.redirect(req.session.connected ? 'home' : 'sign-in');\n\t\t}\n\t);\n});\n\napp.get('/documents', (req, res) =>\t\t res.redirect('/documents/list'));\napp.get('/documents/list', (req, res) => render(req, res, 'documents', { display: 'list' }) );\napp.get('/course/:id-:codeUE', (req, res) => {\n\tconnection.query('SELECT * FROM Course WHERE id = ?', [+req.params.id], (err, results) => {\n\t\tif(results.length==0)\n\t\t\treturn res.redirect('/404/ue');\n\t\tlet course = results.pop();\n\t\tconnection.query('SELECT * FROM Document WHERE courseId = ?', [+course.id], (err, results) => {\n\t\t\tconsole.log(err, results);\n\t\t\trender(req, res, 'documents', { display: 'ue', documents: results.map(function(o){\n\t\t\t\to.tags = o.tags.split('|');\n\t\t\t\treturn o;\n\t\t\t}), course: course });\n\t\t})\n\t});\n});\napp.get('/document/:id-:name', (req, res) => {\n\tconnection.query('SELECT * FROM Document WHERE id = ?', [+req.params.id], (err, results) => {\n\t\tif(results.length==0)\n\t\t\treturn res.redirect('/404/doc');\n\t\tlet doc = results.pop();\n\t\tdoc.tags = doc.tags.split('|');\n\t\trender(req, res, 'documents', { display: 'pdf', document: doc, documentStr: JSON.stringify(doc) });\n\t});\n});\n\napp.get('/:page', (req, res) => {\n\tif(req.params.page=='tutoring')\n\t\treturn res.redirect('/forum');\n\tif(pages.find((page) => page.url==req.params.page))\n\t\trender(req, res, req.params.page);\n\telse\n\t\tres.redirect(\"/index\");\n});\n\napp.listen(5765);\n"]}